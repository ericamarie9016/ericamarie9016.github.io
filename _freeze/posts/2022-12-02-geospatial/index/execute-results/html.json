{
  "hash": "572085e3067ac2614d57df21bc8fe2a3",
  "result": {
    "markdown": "---\ntitle: \"Geospatial Blog Post\"\ndescription: \"Creating a Function for Coastal Species Habitat\"\nauthor:\n  - name: Erica Dale\n    url: http://ericamarie9016.githubt.io\n    affiliation: MEDS\n    affiliation-url: http://ucsb-meds.github.io\ndate: 2022-12-02\nformat:\n  html:\n    code-fold: false\n    code-summary: \"Show the code\"\ncode-overflow: wrap\ncode-block-bg: true\ncode-block-border-left: \"#6B5A75\"\ncategories: [MEDS, Geospatial, R, Coastal Ecology]\ncitation: \n  url: http://ericamarie9016.github.io/2022-12-02-geospatial\n#bibliography: references.bib\n# image: \n# draft: TRUE\n---\n\n\n### Introduction\n\nThis project was adapted from an assignment to explore the suitable habitats for species along the Western Coast, beginning with an Oyster and then creating a function to explore any species. The parameters to explore are depth and sea surface temperature. This could further be expanded with more variables, including change of temperature within the water column. These regions are broken down to five Exclusive Economic Zones (EEZ) along the West Coast of the US.\n\nThis could be applied for restoration efforts to determine where habitat is suitable for any oceanic species.\\\n\n### Data\n\n-   Average annual sea surface temperature (SST) from the years 2008 to 2012: [NOAA's 5km Daily Global Satellite Sea Surface Temperature Anomaly v3.1](https://coralreefwatch.noaa.gov/product/5km/index_5km_ssta.php).\n\n-   Depth of the ocean: [General Bathymetric Chart of the Oceans (GEBCO)](https://www.gebco.net/data_and_products/gridded_bathymetry_data/#area).[^1]\n\n-   Exclusive Economic Zones off of the west coast of US: [Marineregions.org](https://www.marineregions.org/eez.php).\n\n[^1]: GEBCO Compilation Group (2022) GEBCO_2022 Grid (<doi:10.5285/e0f0bb80-ab44-2739-e053-6c86abc0289c>).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(terra)\nlibrary(here)\nlibrary(sf)\nlibrary(tidyverse)\nlibrary(tmap)\nlibrary(ggpubr)    # Combines ggplots\n```\n:::\n\n\nThe data is in both raster and vector formats, reprojected to match coordinate reference systems. The series of raster files depicting each yearly sea surface temperature are all collapsed to show the average for the time range.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### IMPORT DATA\n\nRegions <- read_sf(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/wc_regions_clean.shp\")\n\nAnnual2008 <- rast(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/average_annual_sst_2008.tif\")\nAnnual2009 <- rast(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/average_annual_sst_2009.tif\")\nAnnual2010 <- rast(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/average_annual_sst_2010.tif\")\nAnnual2011 <- rast(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/average_annual_sst_2011.tif\")\nAnnual2012 <- rast(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/average_annual_sst_2012.tif\")\n\nDepth <- rast(\"~/MEDS/Fall-EDS223-Geospatial/data/data_4/depth.tif\")\n\n\n#### STACK ANNUAL DATA\nSSTAnnual <- c(Annual2008, Annual2009, Annual2010, Annual2011, Annual2012)\n\n\n#### Reproject\nst_crs(SSTAnnual)     # WGS84, EPSG 9122\nst_crs(Regions)       # WGS84 EPSG 4326\nst_crs(Depth)         # WGS84, EPSG 4326\n\nSSTAnnual <- project(SSTAnnual, Depth)\nst_crs(SSTAnnual)     # WGS84, EPSG 4326\n\n\n#### Find mean Sea Surface Temperature\n\n# Collapse down layers to one SST mean\nSSTMean <- mean(SSTAnnual)\nSSTMean <- (SSTMean$mean - 273.15)\n\n#Check they will match\nSSTDepth <- c(Depth, SSTMean)\n```\n:::\n\n\n### Find suitable locations\n\nReclassification here is used to select cells matching range of sea surface temperature and depth suitable for Oysters and set them as 1, all other cells are set as NA. A function is then used to combine the two reclassified raster files to find cells that satisfy both. Each plot depicts the reclassified cells for each step.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Set up reclassification matrices\nSSTrcl <- matrix(c(-Inf, 11, NA,\n                   11, 30, 1,        # sea surface temperature: 11-30Â°C\n                   30, Inf, NA),\n                     ncol = 3, byrow = TRUE)\nOysterSST <- classify(SSTMean, rcl = SSTrcl)\nplot(OysterSST, col = \"blue\", main = \"Suitable Sea Surface Temperature for Oysters\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\nDepthrcl <- matrix(c(-Inf, -70, NA,\n                     -70, 0, 1,      # depth: 0-70 meters below sea level\n                     0, Inf, NA),\n                     ncol = 3, byrow = TRUE)\nOysterDepth <- classify(Depth, rcl = Depthrcl)\nplot(OysterDepth, col = \"blue\", main = \"Suitable Depth for Oysters\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n```{.r .cell-code}\n#### Overlay # Find areas that satisfy BOTH\nfun_mult = function(x,y){return(x*y)}     # Function to multiply layers\n\nOystersHabitat <- lapp(c(OysterSST, OysterDepth), fun_mult)\nplot(OystersHabitat, col = \"blue\", main = \"Suitable Habitat for Oysters\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-3.png){width=672}\n:::\n:::\n\n\n### Determine the most suitable EEZ\n\nThe Regions vector is now overlayed with the Oysters Habitat as a mask to determine suitable habitat in each region.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Turn Regions data into raster\nRegions$rgn <- as.factor(Regions$rgn)\nRegionsRast <- rasterize(vect(Regions), OystersHabitat, field = \"rgn\")\nplot(RegionsRast)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#### Select suitable cells in EEZ\nROmask <- mask(RegionsRast, OystersHabitat)\n\n\n#### Find total suitable area within each EEZ\nOysterZone <- expanse(ROmask, unit = \"km\", byValue = TRUE)\n\n\n#### Find percentage of each zone\nOysterRegion <- cbind(OysterZone, Regions)\nOysterRegion <- OysterRegion |> \n  mutate(percent = (area/area_km2)*100)\n```\n:::\n\n\n### Visualizations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#### Total suitable area by region\ntm_shape(OysterRegion) +\n  tm_polygons(\"area\", palette = \"YlGn\") +\n  tm_text(text = \"rgn\",\n          size = .7) +\n  tm_layout(main.title = \"Suitable Oyster Area\",\n            main.title.size = 1.2,\n            main.title.position = \"center\") +\n  tm_layout(legend.position = c(\"left\", \"bottom\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nSome legend labels were too wide. These labels have been resized to 0.55, 0.55, 0.55. Increase legend.width (argument of tm_layout) to make the legend wider and therefore the labels larger.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#### Percent suitable area by region\ntm_shape(OysterRegion) +\n  tm_polygons(\"percent\", palette = \"YlGn\") +\n  tm_text(text = \"rgn\",\n          size = .7) +\n  tm_layout(main.title = \"Suitable Oyster Percentage\",\n            main.title.size = 1.2,\n            main.title.position = \"center\") +\n  tm_layout(legend.position = c(\"left\", \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n:::\n\n\n### Creating a Function\n\nThis function will repeat the previous steps for any species habitat with the inputs of temperrature and depth ranges.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSpecies_Habitat <- function(species_name, temp_min, temp_max, depth_max, depth_min){\n  \n  # RECLASSIFICATION\n  SSTrcl <- matrix(c(-Inf, temp_min, NA,\n                   temp_min, temp_max, 1,\n                   temp_max, Inf, NA),\n                   ncol = 3, byrow = TRUE)\n  Depthrcl <- matrix(c(-Inf, depth_max, NA,\n                     depth_max, depth_min, 1,\n                     depth_min, Inf, NA),\n                     ncol = 3, byrow = TRUE)  \n  \n  # APPLY RECLASS TO BOTH\n  SpeciesSST <- classify(SSTMean, rcl = SSTrcl)\n  SpeciesDepth <- classify(Depth, rcl = Depthrcl)\n  SpeciesHabitat <- lapp(c(SpeciesSST, SpeciesDepth), fun_mult)\n  \n  # SELECT SUITABLE CELLS IN EEZ\n  Regions$rgn <- as.factor(Regions$rgn)\n  RegionsSpecRast <- rasterize(vect(Regions), SpeciesHabitat, field = \"rgn\")\n  RSpecmask <- mask(RegionsSpecRast, SpeciesHabitat)\n\n  # TOTAL SUITABLE AREA PER EEZ\n  SpeciesZone <- expanse(RSpecmask, unit = \"km\", byValue = TRUE)\n  SpeciesZone # Error on row number matching???\n\n  # PERCENTAGE PER EEZ\n  SpeciesRegion <- cbind(SpeciesZone, Regions)\n  SpeciesRegion <- SpeciesRegion |>\n     mutate(percent = (area/area_km2)*100)\n  \n  # MAP AREA BY REGION\n  SpecAreaMap <- tm_shape(SpeciesRegion) +\n  tm_polygons(\"area\", palette = \"YlGn\") +\n  tm_text(text = \"rgn\",\n          size = .7) +\n  tm_layout(main.title = print(paste0(species_name,  \" Suitable Area\")),\n            main.title.size = 1.2,\n            main.title.position = \"center\") +\n  tm_layout(legend.position = c(\"left\", \"bottom\"))\n\n  # MAP PERCENT BY REGION\n  SpecPercMap <- tm_shape(SpeciesRegion) +\n  tm_polygons(\"percent\", palette = \"YlGn\") +\n  tm_text(text = \"rgn\",\n          size = .7) +\n  tm_layout(main.title = print(paste0(species_name, \" Suitable Percentage\")),\n            main.title.size = 1.2,\n            main.title.position = \"center\") +\n  tm_layout(legend.position = c(\"left\", \"bottom\"))\n  \n  # DISPLAY MAPS\n  tmap_arrange(SpecAreaMap, SpecPercMap)\n  \n}\n\n\nSpecies_Habitat(\"Bearica\", 17, 33, -20, 0)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"Bearica Suitable Area\"\n[1] \"Bearica Suitable Percentage\"\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}