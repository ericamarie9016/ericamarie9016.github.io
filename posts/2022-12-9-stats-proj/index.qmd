---
title: "Statistics Blog Post"
description: "Exploring the variation of Urchin counts in protected versus developed piers in Southern California."
author:
  - name: Erica Dale
    url: http://ericamarie9016.githubt.io
    affiliation: MEDS
    affiliation-url: http://ucsb-meds.github.io
date: 2022-11-18
format:
  html:
    code-fold: true
    code-summary: "Show the code"
code-overflow: wrap
code-block-bg: true
code-block-border-left: "#6B5A75"
categories: [MEDS, Statistics, R, Southern California, Urchins]
citation: 
  url: http://ericamarie9016.github.io/2022-12-9-stats-proj
#bibliography: references.bib
# image: 
# draft: TRUE
---

```{r setup, include=FALSE}
# All libraries here
library(tidyverse)
library(lubridate)
library(ggpubr)    # Combines ggplots
library(here)      # Set location
library(readr)
library(gt)
library(tufte)
library(feasts)
library(knitr)     # Creates nice tables
```

# Research Question

The aim of this project is to visualize the impact of protected regions on Urchin density plus selected bivalves, gastropods and crabs. This will provide an understanding of sensitivities these species have to developed coastlines.

#### Let's explore the littoral zone!

##### The locations are at the end of piers, in the marine littoral zone:

The littoral zone is below the low-tide level and experiences the effects of tidal and longshore currents, and breaking waves ().

This dataset has 8 survey locations off piers in Southern California. Two of the piers are off protected coastal regions, the rest are populated and developed piers. The protected regions are all parks with minimal development and a marine conservation area protecting surrounding water. Gaviota Beach Pier with Kashtayit State Marine Conservation Area. Point Cabrillo Pier with the Point Cabrillo State Marine Reserve. Anacapa Island Pier with a variety of marine protected areas surrounding the Channel Islands chain.

##### This data set explores a variety of species:

-   **Arthropoda**: Phylum of lobsters, crabs, barnacles. Cuticle/exoskeleton made of chitin often mineralised with calcium carbonate (issue with ocean acidification).

-   **Bivalvia**: class belonging to phylum Mollusca, filter feeders such as clams, oysters, and mussels.

-   **Gastropoda**: class belonging to phylum Mollusca including snails, conch, abalone, limpets, and whelks with a range from scavengers, predators, herbivores, parasites

-   **Ophiuroidea/Asterpodea**: brittle stars and sea stars belonging to phylum Echinodermata , carnivores, filter feeders, and scavengers

-   **S purpuratus**: Pacific purple sea urchin, a sedentary species primarily feeding on algae

-   **M franciscanus**: Red sea urchins, eat kept and seaweed

-   **Total Urchins**: counts the last two, *S purpuratus* and *M franciscanus*.

Sea urchins and their environment interactions

https://oceanconservancy.org/blog/2020/07/29/sea-urchins/

-   Grind and scrape algee, plankton, kelp

-   Grazers keep algae in check, which helps reduce algae takeover in corals depriving sunlight access

https://www.discovermagazine.com/environment/why-are-sea-urchins-so-destructive-to-kelp-forests

-   Coexist peacefully in kelp forests (Southern Africa to Southern Alaska) until out of balance

-   Healthy kelp forests, urchins feed mainly on detritus/scraps of kelp that shed naturally, stay in hiding spots and eat fallen scraps of kelp

-   When detritus is scares, urchins begin to leave their hiding spots to search for food, feeding on living kelp - "urchin barrens"

-   Not simply overpopulation, can shift between kelp forests and urchin barrens without changing urchin density

Smith, J. G., *et al*. (2022) Alternations in the foraging behaviour of a primary consumer drive patch transition dynamics in a temperate rocky reef ecosystem. *Ecology Letters.* [doi:10.1111/ele.14064](https://doi.org/10.1111/ele.14064).

-   2014 outbreak of sea urchins along California's Central coast causing urchin barrens - causes was: loss of their main predator (sunflower sea star due to sea star wasting disease) and maritime heatwave made it difficult for kelp to grow, main culprit of eating living kelp was purple sea urchins

------------------------------------------------------------------------

# Data Collection and Tidying

### Importing and Creating Data Frames

I imported the Urchin dataset found via LTER Santa Barbara Coastal, the metadata stated NA's were written in the data as '-99999'.

```{r output=FALSE}
## Import Urchins data 
UrchinsDF <- read_csv(here("posts", "2022-12-9-stats-proj", "Invertebrate_Settlement_All_Years_20220722.csv"), na = "-99999")
names(UrchinsDF)                    # Review the column names
unique(UrchinsDF$SITE)              # View the names of the Urchin sites

```

The protection data was not immediately available, I had to create a data frame with the values 1 for protected, 0 for unprotected. I determined protection by the location of the piers. A pier is labeled unprotected if located in populated developed areas such as Ocean Beach, San Diego. Protected piers are located in undeveloped parks surrounded by marine protected areas, including Channel Islands National Park and Point Cabrillo State Marine Reserve.

```{r}
## Create Protection data frame
ProtectionDF <- data.frame(
  Fullname = c("Anacapa", "Point Cabrillo", "Gaviota", "Ocean Beach", "Ellwood Pier", "Stearns Wharf", "Scripps", "Avila Beach"),
  SITE = c("ANACAPA", "FBPC", "GAVIOTA", "OCNBCH", "SBELL", "SBSTWRF", "SIO", "AVILA"),
  Protection = c(1, 1, 1, 0, 0, 0, 0, 0)
)
head(ProtectionDF, n = 8)
```

### Combine Data Frames

Here the two dataframes are joined so all of the survey rows are connected with a protection status based on location. Protection status is changed to be a binary TRUE/FALSE option.

```{r output=FALSE}
## Join and select column fields
Urchins <- left_join(UrchinsDF, ProtectionDF, by = "SITE") |> 
  select(SITE, Protection, DATE_RETRIEVED, ARTHROPODA, BIVALVIA, GASTROPODA, OPHIUROIDEA_ASTERPODEA, S_PURPURATUS, M_FRANCISCANUS, TOTAL_URCHINS)

## Set as date class
Urchins$DATE_RETRIEVED <- lubridate::mdy(Urchins$DATE_RETRIEVED)

## Collapse repeated surveys per day by site
Urchins <- Urchins |> 
  group_by(SITE, DATE_RETRIEVED) |>        # Combine by date, per site
  summarise(ARTHROPODA = sum(ARTHROPODA, na.rm = TRUE),
            BIVALVIA = sum(BIVALVIA, na.rm = TRUE),
            GASTROPODA = sum(GASTROPODA, na.rm = TRUE),
            OPHIUROIDEA_ASTERPODEA = sum(OPHIUROIDEA_ASTERPODEA, na.rm = TRUE),
            S_PURPURATUS = sum(S_PURPURATUS, na.rm = TRUE),
            M_FRANCISCANUS = sum(M_FRANCISCANUS, na.rm = TRUE),
            TOTAL_URCHINS = sum(TOTAL_URCHINS, na.rm = TRUE),
            Protection = mean(Protection))

# Change class to TRUE/FALSE for use in ggplot shape aesthetic
Urchins$Protection <- as.logical(Urchins$Protection)
```

```{r}
head(Urchins)
```

### Tidy Data

Next the total urchin row is removed to focus on each species then pivoted the entire frame longer along each Species.

```{r}
## Create Species Data Frame
SpeciesDF <- Urchins |>
  pivot_longer(cols = c("ARTHROPODA", "BIVALVIA", "GASTROPODA", "OPHIUROIDEA_ASTERPODEA", "S_PURPURATUS", "M_FRANCISCANUS", "TOTAL_URCHINS"),
               names_to = "Species",
               values_to = "Count",
               values_drop_na = TRUE)              # Drop NA values

# Add a binary row for species presence 
SpeciesDF$Present[SpeciesDF$Count >=1] <- 1
SpeciesDF$Present[SpeciesDF$Count ==0] <- 0


# Dataframe displays only binary presence for each species per survey
PresentDF <- SpeciesDF |> 
  select(-Count) |> 
  pivot_wider(values_from = "Present",
              names_from = "Species")
```

------------------------------------------------------------------------

# Data Exploration

Summary provides an overview of each variable (column) and the range of values found over the surveys.

```{r}
print(summary(Urchins))
```

## Initial visualizations

These initial visualizations can provide clues to trends in the data.

```{r}
TotalUrchins <- ggplot(Urchins, aes(x = DATE_RETRIEVED, y = TOTAL_URCHINS)) +
  geom_point(aes(color = SITE, shape = Protection), alpha = .7, size = 2) +
  theme_minimal() +
  labs(title = "Total Species Collected at Sites in Southern CA",
       y = "Total Species Count",
       x = "Date Collected",
       color = "Site", shape = "Protection") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = .5)) +
  scale_color_brewer(palette = "Set1")
TotalUrchins
```

Below is a series of maps of species abundance over time for each survey site. We see a lot of high spikes in this data, and does not appear linear in nature.

```{r}
## How does each species vary per site:

Ana <- SpeciesDF |> 
  filter(SITE == "ANACAPA") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Anacapa") +
  xlab("Date Collected") +
  ylab("Species Count")

FBPC <- SpeciesDF |> 
  filter(SITE == "FBPC") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Point Cabrillo") +
  xlab("Date Collected") +
  ylab("Species Count")

Gav <- SpeciesDF |> 
  filter(SITE == "GAVIOTA") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Gaviota") +
  xlab("Date Collected") +
  ylab("Species Count")

OB <- SpeciesDF |> 
  filter(SITE == "OCNBCH") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Ocean Beach") +
  xlab("Date Collected") +
  ylab("Species Count")

EL <- SpeciesDF |> 
  filter(SITE == "SBELL") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Ellwood Pier") +
  xlab("Date Collected") +
  ylab("Species Count")

SW <- SpeciesDF |> 
  filter(SITE == "SBSTWRF") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Stearns Wharf") +
  xlab("Date Collected") +
  ylab("Species Count")

Scrip <- SpeciesDF |> 
  filter(SITE == "SIO") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Scripps") +
  xlab("Date Collected") +
  ylab("Species Count")

AV <- SpeciesDF |> 
  filter(SITE == "AVILA") |> 
  ggplot(aes(x = DATE_RETRIEVED, y = Count, color = Species)) +
  geom_line() +
  theme_minimal() +
  labs(title = "Avila Beach") +
  xlab("Date Collected") +
  ylab("Species Count")

ggarrange(Ana, FBPC, Gav, OB, EL, SW, Scrip, AV + rremove("x.text"), 
          ncol = 2, nrow = 4,
          common.legend = TRUE,
          legend = "right")
```

------------------------------------------------------------------------

## Plan

First, I want to check if there is a difference in means between protected and unprotected sites for total urchins and other species. The goal is to understand if any species are sensitive to unprotected regions. The null hypothesis predicts there is no change between the abundance of each species in protected versus unprotected regions. I will repeat this for each listed species and total urchins.

$$H_0: \mu_{protected} - \mu_{unprotected} = 0 $$

$$H_A: \mu_{protected} - \mu_{unprotected} \neq  0 $$

## Analysis

### Hypothesis Testing

Welch's Two Sample t-test

```{r}
Protect_Ttest <- t.test(Urchins$TOTAL_URCHINS[Urchins$Protection == 1],
       Urchins$TOTAL_URCHINS[Urchins$Protection == 0])
# Significant

Art_Ttest <- t.test(Urchins$ARTHROPODA[Urchins$Protection == 1],
       Urchins$ARTHROPODA[Urchins$Protection == 0])
# Significant

Biv_Ttest <- t.test(Urchins$BIVALVIA[Urchins$Protection == 1],
       Urchins$BIVALVIA[Urchins$Protection == 0])
# Significant

Gast_Ttest <- t.test(Urchins$GASTROPODA[Urchins$Protection == 1],
       Urchins$GASTROPODA[Urchins$Protection == 0])
# Significant

Oph_Ttest <- t.test(Urchins$OPHIUROIDEA_ASTERPODEA[Urchins$Protection == 1],
       Urchins$OPHIUROIDEA_ASTERPODEA[Urchins$Protection == 0])
# Not Significant

Purp_Ttest <- t.test(Urchins$S_PURPURATUS[Urchins$Protection == 1],
       Urchins$S_PURPURATUS[Urchins$Protection == 0])
# Significant

Fran_Ttest <- t.test(Urchins$M_FRANCISCANUS[Urchins$Protection == 1],
       Urchins$M_FRANCISCANUS[Urchins$Protection == 0])
# Not Significant
```

Total urchins found that protected regions had a mean of 6 urchins, and unprotected a total of 8 species. There is a 95% change of the difference in mean between total urchins in protected and unprotected sites falling between \[-4.84, .26\]. Notably, this range includes 0 and the p-value is not low at p = .08 so the null hypothesis cannot be rejected. This means we do not find a signficant difference in total urchins per survey between the protected and unprotected regions.

The Purple Sea Urchin and Brittle Star also had higher p-values (.08 and .67 respectively) so unable to reject the null hypothesis of no difference between the means of protected versus unprotected regions.

This is not true for every case:

```{r}
kable(tribble(~Species, ~Confidence, ~Pvalue, ~Protected, ~Unprotected,
      "Total Urchins", "[3.29, 9.99]", "<.001", 12, 5,
       "Arthropoda", "[-12.97, -8.37]", "<.001", 6, 16,
       "Bivalvia", "[-121.12, -71.34]", "<.001", 44, 140,
       "Gastropoda", "[5.95, 15.7]", "<.001", 22, 11,
       "Sea Stars", "[-.07, .53]", ".13", 1, 0,
       "S purpuratus", "[3.18, 9.82]", "<.001", 11, 5,
       "M franciscanus", "[-.05, .17]", ".32", 0, 0))
```

The only two that were not significant, also had extremely low means for counts per survey close to 0.

Rewrite the below numbers:

The difference of means between protected and unprotected sites for Arthropoda is signficant with a pvalue less than .01, suggesting we can reject the null hypothesis. There is a 95% probabilty that the true difference in means falls between \[-15.86, -12.08\]. There is an average of 15 Arthropoda in protected sites, versus 1 in unprotected.

The Bivalvia class also had a signficant difference with a 95% probability that the true difference in means is between \[-136.6, -98.6\]. The pvalue of under .01 suggests we can reject the null hypothesis. There is an average of 128 Bivalvia found in protected sites, versus 10 in unprotected. Gastropoda and M franciscanus also had significant p-values, shown in the table below.

## DOUBLE CHECK X/Y for protected/unprotected

### The above data led to the question...

Does it make sense to combine total urchins for surveys, or count them separately? How to make this code make sense???

```{r}
summary(lm(TOTAL_URCHINS ~ M_FRANCISCANUS, data = Urchins))
summary(lm(TOTAL_URCHINS ~ S_PURPURATUS, data = Urchins))
summary(lm(TOTAL_URCHINS ~ OPHIUROIDEA_ASTERPODEA, data = Urchins))
```

### Interaction Model Ideas

-   Exploring species interactions to understand the ecological dynamics.

```{r}
# Basic linear regression of impact of protection on urchins, no time variable
# summary(lm(species1 ~ species2 + species3 + Protection + Protection:species2, data = Urchins)) # Cannot use y as an interaction, look at species??


# Each species on total urchins
summary(lm(TOTAL_URCHINS ~ ARTHROPODA + BIVALVIA + GASTROPODA + OPHIUROIDEA_ASTERPODEA, data = Urchins))

# Species Interactions focused on which species of urchin




#### Look at interaction of protection with species that have significant difference in protection
# summary(lm(TOTAL_URCHINS ~ ARTHROPODA + BIVALVIA + GASTROPODA + OPHIUROIDEA_ASTERPODEA + Protection + :Protection, data = Urchins))
```

### Time Series Ideas

$$
Time Series: Presence = B_0 + B_1 date_t + B_2 protection + E_t
$$

-   Time versus density

-   Before/After Heat Blob 2014 Recovery

    -   2 time series, 1 species or total, 1 protected and 1 no

Attempted a time series, because I wanted to explore the time variable. Look at

```{r}

# Time series Time versus Density in Protected versus Unprotected
# Focused on the species with a high sensitivity to protection

summary(lm(TOTAL_URCHINS ~ DATE_RETRIEVED + Protection, data = PresentDF))

ggplot(PresentDF, aes(x = DATE_RETRIEVED, y = TOTAL_URCHINS, color = Protection)) +
  geom_jitter(height = .1, alpha = .7) +
  geom_smooth(method = lm) +
  theme_minimal() +
  labs(title = "Presence of Total Urchins") +
  xlab("Date Collected") +
  ylab("Present or Absent") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = .5))
  
# High pvaslie, change is not statistically significant due to time
# Interaction, .24 high pvalue, interaction significance
### 24% probability get sample from the population even if null were true
# Do not have enough evidence to reject the null
# What are the values?

ggplot(PresentDF, aes(x = DATE_RETRIEVED, y = ARTHROPODA, color = Protection)) +
  geom_jitter(height = .1, alpha = .7) +
  geom_smooth(method = loess) +
  theme_minimal() +
  labs(title = "Presence of Arthropoda") +
  xlab("Date Collected") +
  ylab("Present or Absent") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = .5))

ggplot(PresentDF, aes(x = DATE_RETRIEVED, y = BIVALVIA, color = Protection)) +
  geom_jitter(height = .1, alpha = .7) +
  geom_smooth(method = loess) +
  theme_minimal() +
  labs(title = "Presence of Bivalvia") +
  xlab("Date Collected") +
  ylab("Present or Absent") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = .5))

ggplot(PresentDF, aes(x = DATE_RETRIEVED, y = GASTROPODA, color = Protection)) +
  geom_jitter(height = .1, alpha = .7) +
  geom_smooth(method = loess) +
  theme_minimal() +
  labs(title = "Presence of Gastropoda") +
  xlab("Date Collected") +
  ylab("Present or Absent") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = .5))

ggplot(PresentDF, aes(x = S_PURPURATUS, y = TOTAL_URCHINS, color = Protection)) +
  geom_jitter(height = .1, alpha = .7) +
  geom_smooth(method = loess) +
  theme_minimal() +
  labs(title = "Presence of Purple Sea Stars") +
  xlab("Date Collected") +
  ylab("Present or Absent") +
  theme(plot.title = element_text(face = "bold",
                                  hjust = .5))
```

```{r}


as_tsibble(Ana) %>%
  model(
    classical_decomposition(value, type = "additive")
  ) %>%
  components() %>%
  autoplot() # why is this not working?

```

# Discussion

This analysis found that some species are more sensitive to protection from coastal human development, including Arthropoda, Bivalvia, Gastropoda, and M franciscanus. Total urchins do not seem sensitive to the difference, but that changes when we separate the two urchin species, as the Purple Pacific Sea Urchin does not show a difference but the Red Sea Urchin does between the sites. Although the confidence interval is close to 0 with the means at 1 and 0, this may need to be reviewed further for signficance as the species appears to have generally low abundance in the data. This signifies an importance to measure them separately

Continued research could look further into the factors that affect these species, such as pollution levels due to high human activity

------------------------------------------------------------------------

# References

Britannica, The Editors of Encyclopaedia. "littoral zone". Encyclopedia Britannica, 8 Aug. 2019, https://www.britannica.com/science/littoral-zone. Accessed 3 December 2022.

https://search.dataone.org/view/https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fmetadata%2Feml%2Fknb-lter-sbc%2F52%2F11#https%3A%2F%2Fpasta.lternet.edu%2Fpackage%2Fdata%2Feml%2Fknb-lter-sbc%2F52%2F11%2F6f1d97294f041ee3d39cda102e0223af
